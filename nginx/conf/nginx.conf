
#user  nobody;
# windows 查看: tasklist /fi "imagename eq nginx.exe"
worker_processes 2;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

# pid        logs/nginx.pid;
events {
  worker_connections 1024;
}

http {
  include mime.types;
  default_type application/octet-stream;

  # log_format main '$remote_addr - $remote_user [$time_iso8601] "$request" '
  # '$status $body_bytes_sent $request_body "$http_referer" '
  # '"$http_user_agent" "$http_x_forwarded_for"';
  # map $time_iso8601 $logdate {
  #   '~^(?<ymd>\d {
  #   }
  #   -\d {
  #   }
  #   -\d {
  #   }
  #   )' $ymd;
  #   default 'nodate';
  # }
  # access_log logs/access/access-$logdate.log main;

  sendfile on;
  # directio off;
  #tcp_nopush     on;

  #keepalive_timeout  0;
  keepalive_timeout 65;

  gzip on;
  gzip_min_length 2k;
  gzip_comp_level 5;
  gzip_types text/css application/json application/javascript;
  gzip_vary on;
  gzip_disable "MSIE [1-6]\.";

  # default 轮询
  # upstream proxy_ops {
  #   server 127.0.0.1:3007;
  #   server 127.0.0.1:3009;
  # }

  # weight 权重
  # upstream proxy_ops {
  #   server 127.0.0.1:3007 weight=8;
  #   server 127.0.0.1:3009 weight=2;
  # }

  # iphash
  # upstream proxy_ops {
  #   ip_hash;
  #   server 127.0.0.1:3007;
  #   server 127.0.0.1:3009;
  # }
  upstream proxy_ops {
    server 127.0.0.1:3007 weight=2 max_fails=2 fail_timeout=10s;
    # server 127.0.0.1:3009 weight=2 max_fails=2 fail_timeout=10s;
  }

  # server_tokens off;
  server {
    # listen 8080;
    listen 8080 ssl http2;
    server_name _;
    proxy_connect_timeout 3s;
    proxy_send_timeout 1s;
    proxy_read_timeout 3s;

    # tls ssl
    ssl_certificate cert/server.crt;
    ssl_certificate_key cert/server.key;
    # ssl_session_cache shared:SSL:1m;
    # ssl_session_timeout 5m;
    # ssl_ciphers RC4:HIGH:!aNULL:!MD5;
    # ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    # ssl_prefer_server_ciphers on;
    # real_ip_recursive on;

    # 502 504
    proxy_next_upstream_timeout 1s;
    proxy_next_upstream_tries 1;
    send_timeout 1s;

    # location ~ .*\.(js|css)?$ {
    #   add_header Cache-Control no-store;
    #   expires -1;
    # }
    if ($request_method = 'OPTIONS') {
      return 204;
    }
    # limit_rate 1M;

    root html;
    location / {
      try_files $uri $uri/ /index.html;
    }
    location /gpi/ {
      proxy_pass http://127.0.0.1:3008/;
    }
    location /api/ {
      proxy_pass http://proxy_ops/;
      proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
      proxy_set_header HOST $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    }
    location ~* \.(gif|jpg|png|jpeg|bmp|css|js|flv|ico|swf|woff|eot)$ {
      access_log on;
      proxy_redirect off;
      proxy_cache_valid 200 302 6h;
      proxy_cache_valid 301 1d;
      proxy_cache_valid any 1m;
      expires 30d;
      # add_header Cache-Control "public, max-age=25920000";
      # add_header Expires "30d";
    }
    # if ($request_uri ~* .*[.](js|css|map|jpg|png|svg|ico)$) {
    #   add_header Cache-Control "public, max-age=25920000";
    #   add_header Expires "30d";
    # }
    # # HTML 启用协商缓存
    # if ($request_filename ~* ^.*[.](html|htm)$) {
    #   add_header Cache-Control "public, no-cache";
    # }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
      root html;
    }
  }

  # autoindex and limit_rate
  server {
    listen 8082;
    server_name _;
    root ../static;
    autoindex on;
    autoindex_exact_size off;
    set $limit_rate 10k;
    location /static {
      root html;
    }
  }

  # limit connect addr
  limit_conn_zone $binary_remote_addr zone=addr:10m;
  # limit_req_zone $binary_remote_addr zone=one:10m rate=2r/s;
  server {
    listen 8084;
    server_name _;
    location / {
      root html;
      limit_conn_status 500;
      limit_conn_log_level warn;
      limit_rate 50;
      limit_conn addr 1;
      # limit_req zone=one burst=3 nodelay;
    }
  }

  # limit ip 403
  server {
    listen 8085;
    location / {
      allow 127.0.0.1;
      allow 192.168.1.0/24;
      deny all;
    }
  }

  server {
    listen 8086;
    location / {
      stub_status on;
      access_log on;
    }
  }

  # 反向代理
  server {
    listen 8087;
    location / {
      proxy_pass https://www.baidu.com;
    }
  }
}

# 反向代理
stream {
  upstream mysql {
    server 182.92.10.187:3306;
  }
  server {
    listen 8083;
    proxy_connect_timeout 1s;
    proxy_timeout 3s;
    proxy_pass mysql;
  }
}
